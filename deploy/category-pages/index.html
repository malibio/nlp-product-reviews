<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Product Review Categories</title>
        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous"
        />
        <!-- Font Awesome for icons -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
            integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
        <!-- Marked.js for Markdown parsing -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <style>
            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background-color: #f8f9fa;
            }
            .container {
                margin-top: 30px;
                margin-bottom: 30px;
            }
            .category-card,
            .product-card {
                border: none;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                margin-bottom: 25px;
                overflow: hidden; /* Ensure rounded corners clip content */
            }
            .review-quote {
                padding: 10px 15px;
                border-left: 5px solid;
                margin-bottom: 10px;
                background-color: #f0f8ff;
                border-radius: 8px;
                font-style: italic;
            }
            .review-quote.border-success {
                border-color: #28a745;
                background-color: #e6ffed;
            }
            .review-quote.border-warning {
                border-color: #ffc107;
                background-color: #fff8e6;
            }
            .rating-stars {
                color: #ffc107; /* Bootstrap yellow */
            }
            .sentiment-positive {
                color: #28a745;
            }
            .sentiment-negative {
                color: #dc3545;
            }
            .sentiment-neutral {
                color: #6c757d;
            }

            /* Specific card styles for AI output alerts */
            .card.border-success .card-header,
            .card.border-primary .card-header {
                background-color: #e0f7fa; /* Light blue for info/AI */
                border-bottom: 1px solid #007bff;
                color: #007bff;
            }
            .card.border-warning .card-header {
                background-color: #fff3cd; /* Light yellow for warning */
                border-bottom: 1px solid #ffc107;
                color: #ffc107;
            }
            .insights-section .badge {
                font-size: 0.8em;
                padding: 0.4em 0.7em;
                border-radius: 0.35rem;
            }
            .markdown-content p:last-child {
                margin-bottom: 0; /* Remove extra margin from last paragraph in markdown */
            }
            /* Styling for markdown content */
            .markdown-body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica,
                    Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
                font-size: 16px;
                line-height: 1.5;
                word-wrap: break-word;
            }
            .markdown-body h1,
            .markdown-body h2,
            .markdown-body h3,
            .markdown-body h4,
            .markdown-body h5,
            .markdown-body h6 {
                margin-top: 1em;
                margin-bottom: 0.5em;
                font-weight: 600;
                line-height: 1.25;
                border-bottom: 1px solid #eaecef; /* Light separator */
                padding-bottom: 0.3em;
            }
            .markdown-body ul,
            .markdown-body ol {
                padding-left: 2em;
                margin-top: 0;
                margin-bottom: 1em;
            }
            .markdown-body code {
                padding: 0.2em 0.4em;
                margin: 0;
                font-size: 85%;
                background-color: rgba(27, 31, 35, 0.05);
                border-radius: 6px;
            }
            .markdown-body pre {
                padding: 16px;
                overflow: auto;
                font-size: 85%;
                line-height: 1.45;
                background-color: #f6f8fa;
                border-radius: 6px;
            }
            .markdown-body blockquote {
                padding: 0 1em;
                color: #6a737d;
                border-left: 0.25em solid #dfe2e5;
                margin: 0.5em 0;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1 class="mb-4 text-center">Product Review Insights Dashboard</h1>

            <div class="mb-4">
                <div class="row">
                    <div class="col-md-6">
                        <label for="modelSelector" class="form-label"
                            >Select Model:</label
                        >
                        <select class="form-select" id="modelSelector"></select>
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <div id="modelStatus" class="ms-3 text-muted"></div>
                    </div>
                </div>
            </div>

            <div
                id="summaryStats"
                class="alert alert-primary mb-4"
                style="display: none !important"
            >
                <h4>Overall Insights <i class="fas fa-chart-bar"></i></h4>
                <p>
                    <strong>Total Products Analyzed:</strong>
                    <span id="statsTotalProducts"></span>
                </p>
                <p>
                    <strong>Total Reviews Processed:</strong>
                    <span id="statsTotalReviews"></span>
                </p>
                <p>
                    <strong>Average Rating Across All Products:</strong>
                    <span id="statsAvgRating"></span>
                </p>
                <p><strong>Sentiment Distribution:</strong></p>
                <div class="progress mb-2" style="height: 25px">
                    <div
                        id="progressPositive"
                        class="progress-bar bg-success"
                        role="progressbar"
                        style="width: 0%"
                        aria-valuenow="0"
                        aria-valuemin="0"
                        aria-valuemax="100"
                    ></div>
                    <div
                        id="progressNegative"
                        class="progress-bar bg-danger"
                        role="progressbar"
                        style="width: 0%"
                        aria-valuenow="0"
                        aria-valuemin="0"
                        aria-valuemax="100"
                    ></div>
                    <div
                        id="progressNeutral"
                        class="progress-bar bg-secondary"
                        role="progressbar"
                        style="width: 0%"
                        aria-valuenow="0"
                        aria-valuemin="0"
                        aria-valuemax="100"
                    ></div>
                </div>
                <p class="text-end">
                    <span class="text-success"
                        ><i class="fas fa-smile"></i> Positive:
                        <span id="percentPositive"></span>%</span
                    >
                    |
                    <span class="text-danger"
                        ><i class="fas fa-frown"></i> Negative:
                        <span id="percentNegative"></span>%</span
                    >
                    |
                    <span class="text-secondary"
                        ><i class="fas fa-meh"></i> Neutral:
                        <span id="percentNeutral"></span>%</span
                    >
                </p>
            </div>

            <div id="categoryCards">
                <!-- Category cards will be injected here -->
            </div>
        </div>

        <!-- Bootstrap JS Bundle -->
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"
        ></script>
        <script>
            let modelConfigs = []; // To store available models and their paths

            // Configure marked.js globally on script load
            marked.setOptions({
                breaks: true, // Treat single newlines as <br>
                gfm: true, // Use GitHub Flavored Markdown
                headerIds: false, // Don't add IDs to headers
                mangle: false, // Don't obfuscate email addresses
            });

            async function detectAvailableModels() {
                // Use static model list for GitHub Pages compatibility
                modelConfigs = [
                    { name: "gemma-2b", path: "gemma-2b" },
                    { name: "gemma-3", path: "gemma-3" },
                    { name: "mistral", path: "mistral" },
                    { name: "qwen", path: "qwen" },
                    { name: "qwen-finetuned", path: "qwen-finetuned" },
                    { name: "gemma-3-finetuned", path: "gemma-3-finetuned" },
                    { name: "gemini-pro-flash", path: "gemini-pro-flash" },
                ];
                populateModelSelector();
                loadSelectedModel();
            }

            async function detectModelFiles(modelPath) {
                // Use static file list for GitHub Pages compatibility
                const expectedFiles = [
                    'e-readers_&_kindle_devices_data.json',
                    'fire_tablets_&_echo_speakers_data.json',
                    'kindle_cases_&_covers_data.json',
                    'charging_&_accessories_data.json',
                    'fire_tv_&_streaming_devices_data.json',
                    'pipeline_stats.json'
                ];

                // Test which files actually exist
                const existingFiles = [];
                for (const file of expectedFiles) {
                    try {
                        const response = await fetch(`outputs/${modelPath}/${file}`);
                        if (response.ok) {
                            existingFiles.push(file);
                        }
                    } catch (e) {
                        // File doesn't exist, skip it
                    }
                }
                
                return existingFiles;
            }

            function populateModelSelector() {
                const selector = document.getElementById("modelSelector");
                selector.innerHTML = ""; // Clear existing options
                modelConfigs.forEach((model) => {
                    const option = document.createElement("option");
                    option.value = model.path;
                    option.textContent = model.name;
                    selector.appendChild(option);
                });

                // Set selected model from localStorage or default to the first one
                const savedModel = localStorage.getItem("selectedModel");
                if (
                    savedModel &&
                    modelConfigs.some((m) => m.path === savedModel)
                ) {
                    selector.value = savedModel;
                } else if (modelConfigs.length > 0) {
                    selector.value = modelConfigs[0].path;
                }

                selector.addEventListener("change", loadSelectedModel);
            }

            async function loadSelectedModel() {
                const selectedModelPath =
                    document.getElementById("modelSelector").value;
                localStorage.setItem("selectedModel", selectedModelPath); // Save preference
                document.getElementById("modelStatus").textContent =
                    `Loading ${selectedModelPath}...`;
                document.getElementById("categoryCards").innerHTML = ""; // Clear previous content
                document.getElementById("summaryStats").style.display = "none"; // Hide stats
                await loadModelData(selectedModelPath);
            }

            async function loadModelData(modelPath) {
                const files = await detectModelFiles(modelPath);
                const categoryDataPromises = [];
                let pipelineStats = null;

                for (const file of files) {
                    const filePath = `outputs/${modelPath}/${file}`;
                    if (file.endsWith("pipeline_stats.json")) {
                        pipelineStats = fetch(filePath).then((res) =>
                            res.json(),
                        );
                    } else if (file.endsWith("_data.json")) {
                        categoryDataPromises.push(
                            fetch(filePath).then((res) => res.json()),
                        );
                    }
                }

                try {
                    const categoryData =
                        await Promise.all(categoryDataPromises);
                    const stats = pipelineStats ? await pipelineStats : null;

                    // Overall Insights section hidden
                    // if (stats) {
                    //     displaySummaryStats(stats);
                    // } else {
                    //     document.getElementById("summaryStats").style.display = "none";
                    // }

                    const categoryCardsContainer =
                        document.getElementById("categoryCards");
                    categoryCardsContainer.innerHTML = ""; // Clear existing cards
                    categoryData.sort((a, b) =>
                        a.category.localeCompare(b.category),
                    ); // Sort categories alphabetically
                    categoryData.forEach((data) => {
                        categoryCardsContainer.appendChild(
                            createCategoryCard(data),
                        );
                    });
                    document.getElementById("modelStatus").textContent =
                        `Data loaded for ${modelPath}.`;
                } catch (error) {
                    document.getElementById("modelStatus").textContent =
                        `Failed to load data for ${modelPath}.`;
                    document.getElementById("categoryCards").innerHTML =
                        '<p class="text-danger">Failed to load data for this model. Please check the console for more details.</p>';
                }
            }

            function createCategoryCard(data) {
                const card = document.createElement("div");
                card.className = "card category-card";

                // Handle both old and new data formats
                const metadata = data.metadata || {};
                const totalReviews =
                    metadata.total_reviews || data.total_reviews || 0;
                const avgRating =
                    metadata.avg_rating || data.stats?.avg_rating || 0;

                const stars =
                    "★".repeat(Math.round(avgRating)) +
                    "☆".repeat(5 - Math.round(avgRating));

                card.innerHTML = `
                <div class="card-header">
                    <h2>${data.category}</h2>
                    <p class="mb-0">Based on ${totalReviews.toLocaleString()} customer reviews | Avg Rating: <span class="rating-stars">${stars}</span> ${avgRating.toFixed(1)}</p>
                </div>
                <div class="card-body">

                    ${
                        data.customer_insights
                            ? `
                    <div class="alert alert-info mb-4">
                        <h5><i class="fas fa-robot"></i> Customer Insights</h5>
                        ${formatCustomerInsights(data.customer_insights)}
                        <small class="text-muted">Generated by ${metadata.generation_info?.model_used || "AI"} in ${(metadata.generation_info?.generation_time || 0).toFixed(1)}s</small>
                    </div>
                    `
                            : data.buying_guide
                              ? `
                    <div class="alert alert-info">
                        <h5><i class="fas fa-robot"></i> ${data.buying_guide.title}</h5>
                        ${formatBuyingGuide(data.buying_guide)}
                        <small class="text-muted">Generated by ${data.buying_guide.model_used} in ${data.buying_guide.generation_time.toFixed(1)}s</small>
                    </div>
                    `
                              : data.ai_content
                                ? `
                    <div class="alert alert-info">
                        <h5><i class="fas fa-robot"></i> AI-Generated Buying Guide (Legacy Format)</h5>
                        ${formatAIContent(data.ai_content.comparison_summary)}
                        <small class="text-muted">Generated by ${data.ai_content.model_used} in ${data.ai_content.generation_time.toFixed(1)}s</small>
                    </div>
                    `
                                : ""
                    }

                    ${
                        data.recommendations
                            ? `
                        ${
                            data.recommendations.top_picks &&
                            data.recommendations.top_picks.length > 0
                                ? `
                        <h5 class="text-success mb-3">
                            <i class="fas fa-thumbs-up"></i> Top Recommendations
                        </h5>
                        <div class="row mb-4">
                            ${data.recommendations.top_picks.map((product, index) => createTopPickCard(product, index + 1)).join("")}
                        </div>
                        `
                                : ""
                        }

                        ${
                            data.recommendations.avoid_products &&
                            data.recommendations.avoid_products.length > 0
                                ? `
                        <h5 class="text-warning mb-3">
                            <i class="fas fa-exclamation-triangle"></i> Consider Carefully
                        </h5>
                        <div class="row mb-4">
                            ${data.recommendations.avoid_products.map((product, index) => createAvoidProductCard(product, index + 1)).join("")}
                        </div>
                        `
                                : ""
                        }
                    `
                            : data.top_products
                              ? `
                        <h5>Top Recommended Products</h5>
                        <div class="row">
                            ${data.top_products.map((product, index) => createProductCard(product, data.sample_reviews[product.name] || [], index + 1)).join("")}
                        </div>
                    `
                              : ""
                    }
                </div>
            `;

                return card;
            }

            function formatMarkdown(text) {
                // Use marked.js for proper markdown rendering
                try {
                    // marked.js options are now set globally
                    const html = marked.parse(text || ""); // Ensure text is not null/undefined

                    // Wrap in markdown-body class for styling
                    return `<div class="markdown-body">${html}</div>`;
                } catch (error) {
                    return `<div class="markdown-body"><pre>${text}</pre></div>`;
                }
            }

            function formatBuyingGuide(guide) {
                // New structured format - cleaner and more reliable
                return `
                <div class="buying-guide-content">
                    ${
                        guide.pros && guide.pros.length > 0
                            ? `
                    <div class="analysis-section mb-4">
                        <h6 class="text-success mb-3">
                            <i class="fas fa-check-circle"></i> Key Strengths
                        </h6>
                        <div class="row">
                            ${guide.pros
                                .map(
                                    (pro) => `
                                <div class="col-md-6 mb-2">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-success me-2 mt-1">✓</span>
                                        <span>${pro}</span>
                                    </div>
                                </div>
                            `,
                                )
                                .join("")}
                        </div>
                    </div>
                    `
                            : ""
                    }

                    ${
                        guide.cons && guide.cons.length > 0
                            ? `
                    <div class="analysis-section mb-4">
                        <h6 class="text-warning mb-3">
                            <i class="fas fa-exclamation-triangle"></i> Important Considerations
                        </h6>
                        <div class="row">
                            ${guide.cons
                                .map(
                                    (con) => `
                                <div class="col-md-6 mb-2">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-warning me-2 mt-1">!</span>
                                        <span>${con}</span>
                                    </div>
                                </div>
                            `,
                                )
                                .join("")}
                        </div>
                    </div>
                    `
                            : ""
                    }

                    ${
                        guide.recommendation
                            ? `
                    <div class="analysis-section mb-3">
                        <div class="card border-primary">
                            <div class="card-body">
                                <h6 class="card-title text-primary mb-2">
                                    <i class="fas fa-lightbulb"></i> AI-Generated Product Guide
                                </h6>
                                <div class="markdown-content">${formatMarkdown(guide.recommendation)}</div>
                            </div>
                        </div>
                    </div>
                    `
                            : ""
                    }

                    ${
                        guide.rating
                            ? `
                    <div class="analysis-section">
                        <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded">
                            <div>
                                <strong class="text-primary">Overall Assessment:</strong>
                                <div class="mt-1">
                                    ${Array.from(
                                        { length: 5 },
                                        (_, i) =>
                                            `<i class="fas fa-star ${i < Math.round(guide.rating) ? "text-warning" : "text-muted"}"></i>`,
                                    ).join("")}
                                    <span class="ms-2 fw-bold">${guide.rating}/5</span>
                                </div>
                            </div>
                            ${
                                guide.total_reviews
                                    ? `
                            <div class="text-end">
                                <small class="text-muted">Based on analysis of</small><br>
                                <strong>${guide.total_reviews.toLocaleString()} reviews</strong>
                            </div>
                            `
                                    : ""
                            }
                        </div>
                    </div>
                    `
                            : ""
                    }
                </div>
            `;
            }

            function formatAIContent(content) {
                // Try to parse as JSON first (fine-tuned model format)
                try {
                    // Clean up the content and extract JSON
                    let cleanContent = content;

                    // --- REMOVED: These lines were stripping newlines and backslashes ---
                    // cleanContent = cleanContent.replace(/\\n/g, ' ');
                    // cleanContent = cleanContent.replace(/\\/g, '');
                    // ------------------------------------------------------------------

                    // Remove Unicode characters that might appear from LLM
                    cleanContent = cleanContent.replace(/[\"\'\']/g, '"'); // Ensure consistent quotes
                    cleanContent = cleanContent.replace(/，/g, ","); // Chinese comma
                    cleanContent = cleanContent.replace(/：/g, ":"); // Chinese colon
                    cleanContent = cleanContent.replace(/、/g, ","); // Japanese comma

                    // Fix common field name typos (still relevant for robust parsing)
                    cleanContent = cleanContent.replace(
                        /"total_review":/g,
                        '"total_reviews":',
                    );
                    cleanContent = cleanContent.replace(/"con":/g, '"cons":');

                    // Find the JSON object more aggressively
                    let jsonText = null;

                    // Extract JSON more aggressively
                    let startPos = cleanContent.indexOf("{");
                    if (startPos !== -1) {
                        let braceCount = 0;
                        let endPos = startPos;

                        for (let i = startPos; i < cleanContent.length; i++) {
                            if (cleanContent[i] === "{") braceCount++;
                            if (cleanContent[i] === "}") {
                                braceCount--;
                                if (braceCount === 0) {
                                    endPos = i + 1;
                                    break;
                                }
                            }
                        }

                        if (braceCount === 0) {
                            jsonText = cleanContent.substring(startPos, endPos);
                        }
                    }

                    if (jsonText) {
                        // Additional cleaning for malformed JSON
                        jsonText = jsonText.replace(/,\s*}/g, "}"); // Remove trailing commas before }
                        jsonText = jsonText.replace(/,\s*]/g, "]"); // Remove trailing commas in arrays
                        jsonText = jsonText.replace(/\]\]/g, "]"); // Fix double closing brackets

                        const parsed = JSON.parse(jsonText);

                        // Ensure arrays for pros and cons
                        let pros = parsed.pros || [];
                        let cons = parsed.cons || [];

                        // Convert single strings to arrays
                        if (typeof pros === "string") pros = [pros];
                        if (typeof cons === "string") cons = [cons];

                        // Filter out empty or invalid entries
                        pros = pros.filter(
                            (item) =>
                                item && typeof item === "string" && item.trim(),
                        );
                        cons = cons.filter(
                            (item) =>
                                item && typeof item === "string" && item.trim(),
                        );

                        // Format as beautiful, readable content (not showing JSON structure)
                        // Now pass recommendation through formatMarkdown if it's treated as markdown
                        return `
                        <div class="ai-analysis-content">
                            ${
                                pros.length > 0
                                    ? `
                            <div class="analysis-section mb-4">
                                <h6 class="text-success mb-3">
                                    <i class="fas fa-check-circle"></i> Key Strengths
                                </h6>
                                <div class="row">
                                    ${pros
                                        .map(
                                            (pro) => `
                                        <div class="col-md-6 mb-2">
                                            <div class="d-flex align-items-start">
                                                <span class="badge bg-success me-2 mt-1">✓</span>
                                                <span>${pro}</span>
                                            </div>
                                        </div>
                                    `,
                                        )
                                        .join("")}
                                </div>
                            </div>
                            `
                                    : ""
                            }

                            ${
                                cons.length > 0
                                    ? `
                            <div class="analysis-section mb-4">
                                <h6 class="text-warning mb-3">
                                    <i class="fas fa-exclamation-triangle"></i> Important Considerations
                                </h6>
                                <div class="row">
                                    ${cons
                                        .map(
                                            (con) => `
                                        <div class="col-md-6 mb-2">
                                            <div class="d-flex align-items-start">
                                                <span class="badge bg-warning me-2 mt-1">!</span>
                                                <span>${con}</span>
                                            </div>
                                        </div>
                                    `,
                                        )
                                        .join("")}
                                </div>
                            </div>
                            `
                                    : ""
                            }

                            ${
                                parsed.recommendation
                                    ? `
                            <div class="analysis-section mb-3">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h6 class="card-title text-primary mb-2">
                                            <i class="fas fa-lightbulb"></i> Expert Recommendation
                                        </h6>
                                        <div class="markdown-content">${formatMarkdown(parsed.recommendation)}</div>
                                    </div>
                                </div>
                            </div>
                            `
                                    : ""
                            }

                            ${
                                parsed.rating
                                    ? `
                            <div class="analysis-section">
                                <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded">
                                    <div>
                                        <strong class="text-primary">Overall Assessment:</strong>
                                        <div class="mt-1">
                                            ${Array.from(
                                                { length: 5 },
                                                (_, i) =>
                                                    `<i class="fas fa-star ${i < Math.round(parsed.rating) ? "text-warning" : "text-muted"}"></i>`,
                                            ).join("")}
                                            <span class="ms-2 fw-bold">${parsed.rating}/5</span>
                                        </div>
                                    </div>
                                    ${
                                        parsed.total_reviews
                                            ? `
                                    <div class="text-end">
                                        <small class="text-muted">Based on analysis of</small><br>
                                        <strong>${parsed.total_reviews.toLocaleString()} reviews</strong>
                                    </div>
                                    `
                                            : ""
                                    }
                                </div>
                            </div>
                            `
                                    : ""
                            }
                        </div>
                    `;
                    }
                } catch (e) {
                }

                // Check if we can manually extract some basic info from malformed JSON
                if (
                    content.includes("pros") ||
                    content.includes("recommendation") ||
                    content.includes("title")
                ) {
                    try {
                        // Extract information even from malformed JSON
                        let title = "Product Analysis";
                        let pros = [];
                        let cons = [];
                        let recommendation = "";

                        // Extract title from various patterns
                        const titlePatterns = [
                            /"title":\s*"([^"]*)"/,
                            /title.*?[\"']([^"']*)/,
                            /Buying Guide[^"]*"([^"]*)/,
                            /"([^"]*Buying Guide[^"]*)"/,
                            /"([^"]*Analysis[^"]*)"/,
                        ];

                        for (const pattern of titlePatterns) {
                            const match = content.match(pattern);
                            if (match && match[1]) {
                                title = match[1];
                                break;
                            }
                        }

                        // Extract pros from various patterns
                        const prosPatterns = [
                            /"pros":\s*\[([^\]]*)\]/,
                            /pros.*?\[([^\]]*)\]/,
                            /"pros_[^"]*":\s*\[([^\]]*)\]/,
                            /Excellent[^"]*"([^"]*)"/,
                            /Good[^"]*"([^"]*)"/,
                            /Strong[^"]*"([^"]*)"/,
                        ];

                        for (const pattern of prosPatterns) {
                            const match = content.match(pattern);
                            if (match && match[1]) {
                                const extracted = match[1]
                                    .split(/[,\\n]/)
                                    .map((p) =>
                                        p
                                            .replace(/['"]/g, "")
                                            .replace(/null/g, "")
                                            .trim(),
                                    )
                                    .filter((p) => p && p.length > 5);
                                pros = pros.concat(extracted);
                            }
                        }

                        // Extract cons from various patterns
                        const consPatterns = [
                            /"cons":\s*\[([^\]]*)\]/,
                            /cons.*?\[([^\]]*)\]/,
                            /Limited[^"]*"([^"]*)"/,
                            /issues?[^"]*"([^"]*)"/,
                        ];

                        for (const pattern of consPatterns) {
                            const match = content.match(pattern);
                            if (match && match[1]) {
                                const extracted = match[1]
                                    .split(/[,\\n]/)
                                    .map((c) =>
                                        c
                                            .replace(/['"]/g, "")
                                            .replace(/null/g, "")
                                            .trim(),
                                    )
                                    .filter((c) => c && c.length > 5);
                                cons = cons.concat(extracted);
                            }
                        }

                        // Extract recommendation
                        const recPatterns = [
                            /"recommendation":\s*"([^"]*)"/,
                            /recommendation.*?[\"']([^"']*)/,
                            /recommended[^"]*"([^"]*)"/,
                        ];

                        for (const pattern of recPatterns) {
                            const match = content.match(pattern);
                            if (match && match[1]) {
                                recommendation = match[1];
                                break;
                            }
                        }

                        // Remove duplicates and clean up
                        pros = [...new Set(pros)].slice(0, 4);
                        cons = [...new Set(cons)].slice(0, 3);

                        if (
                            title ||
                            pros.length ||
                            cons.length ||
                            recommendation
                        ) {
                            // Pass recommendation through formatMarkdown here as well
                            return `
                            <div class="ai-analysis-content">
                                <h6 class="mb-3"><strong>${title}</strong></h6>

                                ${
                                    pros.length > 0
                                        ? `
                                <div class="analysis-section mb-3">
                                    <h6 class="text-success mb-2">
                                        <i class="fas fa-check-circle"></i> Key Strengths
                                    </h6>
                                    ${pros
                                        .map(
                                            (pro) => `
                                        <div class="d-flex align-items-start mb-1">
                                            <span class="badge bg-success me-2 mt-1">✓</span>
                                            <span>${pro}</span>
                                        </div>
                                    `,
                                        )
                                        .join("")}
                                </div>
                                `
                                        : ""
                                }

                                ${
                                    cons.length > 0
                                        ? `
                                <div class="analysis-section mb-3">
                                    <h6 class="text-warning mb-2">
                                        <i class="fas fa-exclamation-triangle"></i> Important Considerations
                                    </h6>
                                    ${cons
                                        .map(
                                            (con) => `
                                        <div class="d-flex align-items-start mb-1">
                                            <span class="badge bg-warning me-2 mt-1">!</span>
                                            <span>${con}</span>
                                        </div>
                                    `,
                                        )
                                        .join("")}
                                </div>
                                `
                                        : ""
                                }

                                ${
                                    recommendation
                                        ? `
                                <div class="analysis-section">
                                    <div class="card border-primary">
                                        <div class="card-body">
                                            <h6 class="card-title text-primary mb-2">
                                                <i class="fas fa-lightbulb"></i> Expert Recommendation
                                            </h6>
                                            <div class="markdown-content">${formatMarkdown(recommendation)}</div>
                                        </div>
                                    </div>
                                </div>
                                `
                                        : ""
                                }
                            </div>
                        `;
                        }
                    } catch (manualError) {
                    }
                }

                return `
                <div class="alert alert-secondary">
                    <h6>AI Analysis (Raw Output):</h6>
                    <pre style="white-space: pre-wrap; font-size: 0.9em;">${content}</pre>
                </div>
            `;
            }

            function formatCustomerInsights(insights) {
                return `
                <div class="customer-insights-content">
                    ${
                        insights.why_customers_choose
                            ? `
                    <div class="insights-section mb-3">
                        <div class="markdown-content">${formatMarkdown(insights.why_customers_choose)}</div>
                    </div>
                    `
                            : ""
                    }

                    ${
                        insights.positive_themes &&
                        insights.positive_themes.length > 0
                            ? `
                    <div class="insights-section mb-3">
                        <h6 class="text-success mb-2">
                            <i class="fas fa-thumbs-up"></i> What Customers Love
                        </h6>
                        <div class="row">
                            ${insights.positive_themes
                                .map(
                                    (theme) => `
                                <div class="col-md-6 mb-1">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-success me-2 mt-1">✓</span>
                                        <span>${theme}</span>
                                    </div>
                                </div>
                            `,
                                )
                                .join("")}
                        </div>
                    </div>
                    `
                            : ""
                    }

                    ${
                        insights.negative_themes &&
                        insights.negative_themes.length > 0
                            ? `
                    <div class="insights-section mb-2">
                        <h6 class="text-warning mb-2">
                            <i class="fas fa-exclamation-circle"></i> Common Concerns
                        </h6>
                        <div class="row">
                            ${insights.negative_themes
                                .map(
                                    (theme) => `
                                <div class="col-md-6 mb-1">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-warning me-2 mt-1">!</span>
                                        <span>${theme}</span>
                                    </div>
                                </div>
                            `,
                                )
                                .join("")}
                        </div>
                    </div>
                    `
                            : ""
                    }
                </div>
            `;
            }

            function createTopPickCard(product, rank) {
                const stars =
                    "★".repeat(Math.round(product.rating)) +
                    "☆".repeat(5 - Math.round(product.rating));
                return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card product-card h-100 border-success">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title text-success">${rank}. ${product.name}</h5>
                            <p class="card-text text-muted">Rating: ${product.rating.toFixed(1)}/5 <span class="rating-stars">${stars}</span> (${product.review_count.toLocaleString()} reviews)</p>
                            ${
                                product.positive_quotes &&
                                product.positive_quotes.length > 0
                                    ? `
                                <div class="mt-auto">
                                    <h6>Customer Highlights:</h6>
                                    ${product.positive_quotes
                                        .map(
                                            (quote) => `
                                        <div class="review-quote border-success">
                                            <p class="mb-0">"${quote.text}"</p>
                                            <small class="text-muted">${quote.rating}/5</small>
                                        </div>
                                    `,
                                        )
                                        .join("")}
                                </div>
                            `
                                    : ""
                            }
                        </div>
                    </div>
                </div>
            `;
            }

            function createAvoidProductCard(product, rank) {
                const stars =
                    "★".repeat(Math.round(product.rating)) +
                    "☆".repeat(5 - Math.round(product.rating));
                return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card product-card h-100 border-warning">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title text-warning">${rank}. ${product.name}</h5>
                            ${
                                product.warning_quotes &&
                                product.warning_quotes.length > 0
                                    ? `
                                <div class="mt-auto">
                                    <h6>Customer Warnings:</h6>
                                    ${product.warning_quotes
                                        .map(
                                            (quote) => `
                                        <div class="review-quote border-warning">
                                            <p class="mb-0">"${quote.text}"</p>
                                            <small class="text-muted">${quote.rating !== null ? `${quote.rating}/5` : "N/A Rating"}</small>
                                        </div>
                                    `,
                                        )
                                        .join("")}
                                </div>
                            `
                                    : ""
                            }
                        </div>
                    </div>
                </div>
            `;
            }

            function createProductCard(product, sampleReviews, rank) {
                const positiveReviews = sampleReviews
                    .filter((r) => r.sentiment === "positive")
                    .slice(0, 2);
                const negativeReviews = sampleReviews
                    .filter((r) => r.sentiment === "negative")
                    .slice(0, 1);
                const stars =
                    "★".repeat(Math.round(product.avg_rating)) +
                    "☆".repeat(5 - Math.round(product.avg_rating));

                return `
                <div class="col-md-4 mb-4">
                    <div class="card product-card h-100">
                        <div class="card-body">
                            <h5 class="card-title">${rank}. ${product.name}</h5>
                            <p class="card-text text-muted">Avg Rating: ${product.avg_rating.toFixed(1)}/5 <span class="rating-stars">${stars}</span></p>
                            <p class="card-text text-muted">${product.review_count.toLocaleString()} reviews</p>
                            ${
                                positiveReviews.length > 0
                                    ? `
                                <h6>Positive Feedback:</h6>
                                ${positiveReviews
                                    .map(
                                        (review) => `
                                    <div class="review-quote border-success">"${review.text}" <small class="sentiment-positive">(${review.rating}/5)</small></div>
                                `,
                                    )
                                    .join("")}
                            `
                                    : ""
                            }
                            ${
                                negativeReviews.length > 0
                                    ? `
                                <h6>Concerns:</h6>
                                ${negativeReviews
                                    .map(
                                        (review) => `
                                    <div class="review-quote border-warning">"${review.text}" <small class="sentiment-negative">(${review.rating}/5)</small></div>
                                `,
                                    )
                                    .join("")}
                            `
                                    : ""
                            }
                        </div>
                    </div>
                </div>
            `;
            }

            function displaySummaryStats(stats) {
                document.getElementById("statsTotalProducts").textContent =
                    stats.unique_products.toLocaleString();
                document.getElementById("statsTotalReviews").textContent =
                    stats.total_reviews.toLocaleString();
                document.getElementById("statsAvgRating").textContent =
                    stats.average_rating.toFixed(2) + "/5";

                const total =
                    stats.sentiment_distribution.positive +
                    stats.sentiment_distribution.negative +
                    stats.sentiment_distribution.neutral;
                const percentPositive =
                    total > 0
                        ? (
                              (stats.sentiment_distribution.positive / total) *
                              100
                          ).toFixed(1)
                        : 0;
                const percentNegative =
                    total > 0
                        ? (
                              (stats.sentiment_distribution.negative / total) *
                              100
                          ).toFixed(1)
                        : 0;
                const percentNeutral =
                    total > 0
                        ? (
                              (stats.sentiment_distribution.neutral / total) *
                              100
                          ).toFixed(1)
                        : 0;

                document.getElementById("percentPositive").textContent =
                    percentPositive;
                document.getElementById("percentNegative").textContent =
                    percentNegative;
                document.getElementById("percentNeutral").textContent =
                    percentNeutral;

                document.getElementById("progressPositive").style.width =
                    `${percentPositive}%`;
                document.getElementById("progressNegative").style.width =
                    `${percentNegative}%`;
                document.getElementById("progressNeutral").style.width =
                    `${percentNeutral}%`;

                document
                    .getElementById("progressPositive")
                    .setAttribute("aria-valuenow", percentPositive);
                document
                    .getElementById("progressNegative")
                    .setAttribute("aria-valuenow", percentNegative);
                document
                    .getElementById("progressNeutral")
                    .setAttribute("aria-valuenow", percentNeutral);

                // Overall Insights section hidden
                // document.getElementById("summaryStats").style.display = "block";
            }

            async function initializePage() {
                await detectAvailableModels();
            }

            // Initialize when DOM is fully loaded
            document.addEventListener("DOMContentLoaded", initializePage);
        </script>
    </body>
</html>
